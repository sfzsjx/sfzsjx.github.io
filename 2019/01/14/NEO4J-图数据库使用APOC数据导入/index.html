<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
    <meta name="description" content="天道酬勤">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    NEO4J 图数据库使用APOC数据导入 |
    
    上善若水博客</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>

<body>
<main class="content">
  <section class="outer">
  

<article id="post-NEO4J-图数据库使用APOC数据导入" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      NEO4J 图数据库使用APOC数据导入
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2019/01/14/NEO4J-图数据库使用APOC数据导入/" class="article-date">
  <time datetime="2019-01-14T06:33:35.000Z" itemprop="datePublished">2019-01-14</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/图数据库/">图数据库</a>
  </div>

      </div>
    

    
      




    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>Neo4j 数据导入</p>
<p>一、安装与部署</p>
<pre><code>直接在官网下载安装包安装，解压即可。
</code></pre><p>二、下载相应的jar包</p>
<p>1.sqlserver 数据导入neo4j的jar包</p>
<blockquote>
<p>apoc-3.4.0.1-all.jar     mssql-jdbc-6.2.2.jre8.jar     sqljdbc4-4.0.jar</p>
</blockquote>
<p>2.mysql 数据导入neo4j的jar包</p>
<blockquote>
<p>apoc-3.3.0.1-all.jar    mysql-connector-java-8.0.8-dmr.jar</p>
</blockquote>
<p>3.将对应jar包放在安装目录plugins文件目录里，然后conf目录里的neo4j.conf的后面加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dbms.security.procedures.unrestricted=apoc.*</span><br><span class="line"></span><br><span class="line">apoc.import.file.enabled=true</span><br><span class="line">apoc.export.file.enabled=true</span><br></pre></td></tr></table></figure>
<p>4.restart neo4j,运行return apoc.version(),若有版本号，则成功。</p>
<p>三、导数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import org.neo4j.driver.v1.*;</span><br><span class="line">public class Connect&#123;</span><br><span class="line">public static void main(String[] args)&#123;</span><br><span class="line"> Driver driver = GraphDatabase.driver(&quot;bolt://localhost:7687&quot;,AuthTokens.basic(&quot;neo4j&quot;,&quot;neo4j&quot;));</span><br><span class="line"> Session session = driver.session();</span><br><span class="line"> String cypher=&quot;create constraint on (n:ITEM) ASSERT n.itemid is unique&quot;; //创建唯一索引，这样可以更快的导入数据</span><br><span class="line"> Session.run(cypher);</span><br><span class="line"> cypher=&quot;CALL apoc.periodic.iterate(\&quot;CALL apoc.load.jdbc(&apos;jdbc:sqlserver://localhost;username=name;password=word;database=db;characterEncoding=utf-8&apos;,\\\&quot;SELECT * FROM TABLE1\\\&quot;)\&quot;,\&quot;MERGE(n:ITEM&#123;itemid:row.mitemid&#125;) with * MERGE(m:ITEM&#123;itemid:row.itemid&#125;) with * create p=(n)-[r:rel&#123;rels:row.rels&#125;]-&gt;(m)\&quot;,&#123;batchSize:10000,iterateList:true&#125;)&quot;;  //连接sqlserve数据库和设计创建neo4j图数据库数据模型</span><br><span class="line"> Session.run(cypher);</span><br><span class="line"> session.close();</span><br><span class="line"> driver.close();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mysql数据库类似,不再赘述。</p>
<p>补充：1.使用neo4j-import导入数据的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neo4j-admin import --nodes:item  &quot;nodes.csv&quot;  --relationships:rel &quot;rel_header.csv,rel.csv&quot; --ignore-missing-nodes</span><br></pre></td></tr></table></figure>
<p>2.apoc 导出命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call apoc.export.cypher.query(</span><br><span class="line">&quot;MATCH (p1:Person)-[r:KNOWS]-&gt;(p2:Person) RETURN p1,r,p2&quot;,</span><br><span class="line">&quot;/tmp/friendships.cypher&quot;,</span><br><span class="line">&#123;format:&apos;plain&apos;,cypherFormat:&apos;updateStructure&apos;&#125;)`</span><br></pre></td></tr></table></figure>
<p>参考： <a href="http://neo4j-contrib.github.io/neo4j-apoc-procedures/#_export_import" target="_blank" rel="noopener">http://neo4j-contrib.github.io/neo4j-apoc-procedures/#_export_import</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">call apoc.export.cypher.query(&quot;match (n:lable) where not (n)--() and n.properties = &apos;400&apos; return distinct(n)&quot;,&quot;C://User/Desktop/test&quot;,&#123;format:&apos;plain&apos;,cypherFormat:&apos;create&apos;&#125;)</span><br></pre></td></tr></table></figure></p>
<p> 3.不用解压也能导数据load csv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load csv from &quot;file:/twitter-2010.txt.gz&quot; as line fieldterminator &apos; &apos; with toInt(line[0]) as id,toInt(line[1]) as id1 return id,id1 limit 10</span><br><span class="line">using periodic commit 1000</span><br><span class="line">load csv from &quot;file:/twitter-2010.txt.gz&quot; as line fieldterminator &apos; &apos; create (item:ITEM&#123;id:line[0],item:line[1]&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="常见问题总结："><a href="#常见问题总结：" class="headerlink" title="常见问题总结："></a>常见问题总结：</h4><blockquote>
<p>问题一、<br>apoc 导数据 时会漏掉一些数据，总是导不全？有一些批次失败。报错信息：{ “Cannot merge node using null property value for dsca”: 8}</p>
</blockquote>
<p>{ “total”: 52562339, “committed”: 52554339, “failed”: 8000, “errors”: { “Cannot merge node using null property value for dsca”: 8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">具体原因：是dsca字段有null值造成的，可以看出导数据时需要先对数据清洗，清除脏数据。</span><br><span class="line">操作：将为null的数据转为&apos;null&apos;字符串。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题二：<br>Caused by: org.neo4j.driver.v1.exceptions.ClientException: Failed to invoke procedure <code>apoc.periodic.iterate</code>: Caused by: com.microsoft.sqlserver.jdbc.SQLServerException: Connection reset<br>数据库连接被重置<br>可能原因有很多：可能数据库关闭了连接，也可能是防火墙和网络的原因，还有一些其他的异常可以通过try{}cathch来捕捉异常来解决。</p>
</blockquote>
<blockquote>
<p>问题三：<br>neo4j由于查询数据量过多导致数据库挂掉。<br>neo4j可能会因一次性查询数据太多，而挂掉。进入neo4j目录bin下。<br>cd到bin目录下，执行启动命令：./neo4j stop<br>另外neo4j还有其他命令，执行方式相同：neo4j { console | start | stop | restart | status }<br>如果，./neo4j stop不能停止neo4j，<br><strong>用kill -s 9 强制杀掉进程。 </strong><br>然后，调用./neo4j start 启动neo4j</p>
</blockquote>
<blockquote>
<p>问题四：<br>neo4j 导数据时程序未出现报错信息，但是一直卡着，数据导入失败。<br>可以查看进程：jps、ps -p pid,直接将所有的关于neo4j的进程kill ,再重新执行数据导入程序<br>在查看进行可以看到有两个进程CommunityEntryPoint和jar.<br>可能造成的原因是由于上次导完数据后的链接数据库为关闭。</p>
</blockquote>
<h3 id="hive数据迁移到neo4j操作"><a href="#hive数据迁移到neo4j操作" class="headerlink" title="hive数据迁移到neo4j操作"></a>hive数据迁移到neo4j操作</h3><ol>
<li>下载与hive版本一致的jar包，如（hadoop-common-2.7.3.jar，hive-exec-1.2.1.jar，hive-jdbc-1.2.1.jar，hive-metastore-1.2.1.jar，hive-service-1.2.1.jar，httpclient-4.4.jar，httpcore-4.4.jar，libfb303-0.9.2.jar，libthrift-0.9.3.jar）</li>
<li>将jar包放入到plugin 目录中</li>
<li>重启neo4j,./neo4j restart</li>
<li>加载驱动，call apoc.load.driver(‘org.apache.hive.jdbc.HiveDriver’)</li>
<li>执行查询，call apoc.load.jdbc(‘jdbc:hive2://ip:1000/database;user=hdfs;password=hdfs’,’select name,age from user’)  YIELD row<br>RETURN row.name, row.age;</li>
</ol>
<p>注意：</p>
<blockquote>
<p>1.hive 查询的时候需要将字段查出来，例如：select name，age from user ,如果使用 select * from user 则返回的数据为null<br>2.hive 表中数据若是太大可能需要查询很久才能，会将数据全部查询出来才才开始进行图的构建。</p>
</blockquote>
<blockquote>
<p>问题五：<br>报错：Node(934582) already exists with label <code>ITEM</code> and property <code>itemid</code> = ‘980_A700100171’<br>原因：由于节点重复导致，由于itemid相同，但是节点其他属性不同，无法完成节点合并<br>解决办法：去掉重复的节点，或者不创建唯一的itemID，但是这样数据导入速度会变慢，故建议采用去掉重复的节点id。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/01/14/NEO4J-图数据库使用APOC数据导入/" data-id="ck3o5qlfj000xhkuj350t6pqu"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neo4j/">neo4j</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2019/01/14/CDH-5-15-简易版离线安装完整版/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            CDH 5.15 简易版离线安装完整版
          
        </div>
      </a>
    
    
      <a href="/2018/08/15/RDD常用算子/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">RDD常用算子</div>
      </a>
    
  </nav>


  

  
    
  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2019 上善若水博客</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="上善若水博客"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

</body>
</html>